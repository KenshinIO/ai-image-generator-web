<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; }
        .card { background-color: #161b22; border: 1px solid #30363d; }
        .btn-primary { background-color: #238636; transition: background-color 0.15s; }
        .btn-primary:hover { background-color: #2ea043; }
        .loading-spinner { border-top-color: #238636; }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-center justify-center">

    <div class="w-full max-w-lg">
        <h1 class="text-3xl font-bold mb-8 text-center text-white">üñºÔ∏è AI Image Generator</h1>
        
        <div class="card p-6 rounded-xl shadow-2xl space-y-6">
            
            <textarea id="prompt-input" rows="3" class="w-full p-4 text-white bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#238636]" placeholder="Deskripsikan gambar yang ingin Anda buat di sini (misalnya: 'Seekor kucing yang memakai helm astronot, gaya seni digital, resolusi 4K')."></textarea>
            
            <button id="generate-btn" class="w-full btn-primary text-white font-bold py-3 rounded-lg flex items-center justify-center disabled:opacity-50">
                <span id="button-text">Buat Gambar AI</span>
                <div id="loading-indicator" class="loading-spinner w-5 h-5 border-4 border-solid rounded-full animate-spin hidden ml-2 border-gray-600"></div>
            </button>
            
            <div id="status-message" class="text-center text-sm font-medium h-5 text-gray-400"></div>

            <div id="image-container" class="mt-6">
                <img id="generated-image" src="https://placehold.co/500x300/161b22/c9d1d9?text=Gambar+Hasil+AI" onerror="this.src='https://placehold.co/500x300/161b22/c9d1d9?text=Gagal+Memuat';" alt="Gambar Hasil AI" class="w-full h-auto rounded-lg shadow-xl aspect-[1.6/1] object-cover border border-[#30363d]">
            </div>

        </div>
    </div>

    <script>
        const promptInput = document.getElementById('prompt-input');
        const generateBtn = document.getElementById('generate-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const buttonText = document.getElementById('button-text');
        const statusMessage = document.getElementById('status-message');
        const generatedImage = document.getElementById('generated-image');
        
        const API_MODEL = 'imagen-4.0-generate-001';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:predict?key=`;
        const API_KEY = "";

        const MAX_RETRIES = 5;
        const INITIAL_BACKOFF_MS = 1000;

        function setStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `text-center text-sm font-medium h-5 mt-2 ${isError ? 'text-red-400' : 'text-green-400'}`;
        }

        function toggleLoading(isLoading) {
            generateBtn.disabled = isLoading;
            loadingIndicator.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Sedang Membuat...' : 'Buat Gambar AI';
            if (isLoading) {
                setStatus('Proses dimulai. Ini mungkin memakan waktu 10-20 detik...', false);
            }
        }

        async function fetchWithExponentialBackoff(payload, retryCount = 0) {
            try {
                const response = await fetch(API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && retryCount < MAX_RETRIES) {
                    const delay = INITIAL_BACKOFF_MS * Math.pow(2, retryCount) + Math.random() * 1000;
                    console.warn(`Too many requests (429). Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithExponentialBackoff(payload, retryCount + 1);
                }

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                return response.json();

            } catch (error) {
                if (retryCount < MAX_RETRIES) {
                    const delay = INITIAL_BACKOFF_MS * Math.pow(2, retryCount) + Math.random() * 1000;
                    console.error(`Fetch failed: ${error.message}. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithExponentialBackoff(payload, retryCount + 1);
                }
                throw new Error("Gagal terhubung ke API setelah beberapa kali coba.");
            }
        }

        async function generateImage() {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                setStatus('Masukkan deskripsi (prompt) gambar terlebih dahulu.', true);
                return;
            }

            toggleLoading(true);

            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": 1 }
            };

            try {
                const result = await fetchWithExponentialBackoff(payload);
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    generatedImage.src = imageUrl;
                    setStatus('Gambar berhasil dibuat!', false);
                } else {
                    setStatus('Pembuatan gambar gagal. Coba prompt yang berbeda.', true);
                    console.error("Struktur respons API tidak valid:", result);
                }
            } catch (error) {
                setStatus(`Gagal total: ${error.message}`, true);
            } finally {
                toggleLoading(false);
            }
        }

        generateBtn.addEventListener('click', generateImage);
    </script>
</body>
</html>